# Bitcoin Blockspace Analysis — Efficient Price, Inefficient Blocks

This repo accompanies the paper “Efficient Price, Inefficient Blocks,” which finds no reliable weekday effects in Bitcoin returns, but persistent, predictable fee overpayment patterns across time-of-day and weekends. The code produces the datasets, visualizations, and the Quarto paper.

Highlights:
- Prices: no stable day-of-week effects worth trading.
- Blockchain usage: users overpay fees predictably (weekends, morning UTC), wasting real money.

Paper source: `paper/paper.qmd` → output: `paper/paper.html`.

## Contents

- `paper/` — Quarto paper and styles.
- `scripts/` — data pulls and visualizations (Plotly/Matplotlib helpers in `viz_utils.py`).
- `sql/` — BigQuery Standard SQL for factor/seasonality/elasticity extracts.
- `data/raw/` — extracted tables (Parquet). Created as you run pulls.
- `data/figs/` — HTML/PNG figures generated by scripts.
- `Makefile` — convenience targets for data extracts and paper render.

## Requirements

- Python 3.11+
- Quarto CLI (to render the paper): https://quarto.org
- Python packages: `pip install -r requirements.txt`
- Optional for data pulls: Google BigQuery access and credentials
   - env var: `GOOGLE_APPLICATION_CREDENTIALS=/absolute/path/to/key.json`

## Setup

```bash
# from repo root (Windows Git Bash shown)
python -m venv .venv
source .venv/Scripts/activate
pip install -r requirements.txt

# optional: configure GCP credentials if pulling data
export GOOGLE_APPLICATION_CREDENTIALS=/c/Path/To/your-key.json
```

## Data extraction (BigQuery → Parquet)

Use the Makefile helpers (edit `PROJECT` and `LOCATION` as needed):

```bash
make init
PROJECT=your-gcp-project-id LOCATION=US make extract_factors
PROJECT=your-gcp-project-id LOCATION=US make extract_elasticity
PROJECT=your-gcp-project-id LOCATION=US make extract_seasonality
```

Under the hood this calls `scripts/run_query.py`, e.g.:

```bash
python scripts/run_query.py \
   --project your-gcp-project-id \
   --location US \
   --sql sql/factors.sql \
   --out data/raw/factors.parquet
```

## Visualizations

Many figures in `data/figs/` are produced by scripts in `scripts/`. A convenient orchestrator runs several pulls and plots:

```bash
# pulls chain data (if needed) and renders figures
python scripts/run_all_visualizations.py --project your-gcp-project-id --years 2

# only re-render visuals (skip pulls)
python scripts/run_all_visualizations.py --visualize_only
```

Individual examples:
- Weekend gap (needs daily price CSV at `data/external/btcusd_daily.csv`):
   ```bash
   python scripts/visualize_weekend_gap_analysis.py --csv data/external/btcusd_daily.csv
   ```
- Fee overpayment patterns (pull + viz):
   ```bash
   python scripts/pull_fee_overpayment_patterns.py --years 2 --project your-gcp-project-id
   python scripts/visualize_fee_overpayment_patterns.py
   ```
- Large transaction timing:
   ```bash
   python scripts/pull_large_transaction_timing.py --years 2 --project your-gcp-project-id
   python scripts/visualize_large_transaction_timing.py
   ```

Outputs land in `data/figs/` as `.html` and `.png`.

## Render the paper

```bash
# using Makefile
make paper

# or directly
quarto render paper/paper.qmd
```

The rendered report is `paper/paper.html` and references interactive figures from `data/figs/`.

## What the paper shows (tl;dr)

- No robust weekday effects in Bitcoin returns across rolling windows and global tests (ANOVA, Kruskal-Wallis, OLS with robust errors).
- Clear, persistent fee overpayment patterns concentrated on weekends and morning UTC hours, amplified when blocks are near capacity.
- Practical implication: schedule non-urgent transactions off-peak; businesses should adopt adaptive fee policies.

## Troubleshooting

- Quarto not found: install from https://quarto.org; verify with `quarto --version`.
- GCP auth errors: ensure `GOOGLE_APPLICATION_CREDENTIALS` points to a valid JSON key; your account has BigQuery access and billing enabled.
- Missing packages: `pip install -r requirements.txt`.
- Figures missing in paper: generate visuals first (see Visualizations) so `paper/paper.html` can load `data/figs/*.html`.

## Citation

If you use this work, please cite the paper:

```
Liam Murphy (2025). Efficient Price, Inefficient Blocks.
```

## License

MIT. See `LICENSE` if present.
